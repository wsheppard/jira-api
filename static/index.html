<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jira In Progress Tickets</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    @keyframes wiggle {
      0%, 8%, 100% { transform: rotate(0deg); }
      4%          { transform: rotate(3deg); }
      6%          { transform: rotate(-3deg); }
    }
    .card.stale {
      animation: wiggle 5.5s ease-in-out infinite;
    }
    .card.stale .card-header {
      background-color: #dc3545;
      color: #fff;
    }

    /* Ticket key styling */
    .ticket-key {
      font-size: 1.25rem;
      font-weight: 500;
      width: 100%;
    }
  </style>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body>
<div class="container my-4">
  <!-- Open tickets by due date first -->
  <h1>Open Tickets by Due Date</h1>
  <div x-data="dueApp()" x-init="init()" class="row row-cols-1 row-cols-md-3 g-4 mb-5">
    <template x-for="ticket in tickets" :key="ticket.ticket">
      <div class="col">
        <a :href="ticket.link" target="_blank" class="text-decoration-none text-body">
          <div :class="{'card h-100 shadow': true, 'stale': isOverdue(ticket.dueDate)}">
            <div :class="isOverdue(ticket.dueDate) ? 'bg-danger text-white card-header' : 'card-header bg-info text-white'">
              <span class="ticket-key d-block text-truncate" x-text="ticket.ticket"></span>
            </div>
            <div class="card-body">
              <p class="card-text" x-text="ticket.title"></p>
              <template x-if="ticket.dueDate">
                <p class="card-text"><small class="text-muted" x-text="'Due: ' + ticket.dueDate"></small></p>
              </template>
              <p class="card-text"><small class="text-muted" x-text="'Updated: ' + timeAgo(ticket.updated)"></small></p>
              <p class="card-text">
                <img :src="ticket.avatarUrl" :alt="ticket.assignee" class="rounded-circle me-2" width="32" height="32">
                <small class="text-muted" x-text="'Assignee: ' + ticket.assignee"></small>
              </p>
            </div>
          </div>
        </a>
      </div>
    </template>
  </div>

  <!-- In-progress tickets below -->
  <h1>In Progress Tickets</h1>
  <div x-data="ticketsApp()" x-init="init()" class="row row-cols-1 row-cols-md-3 g-4">
    <template x-for="ticket in tickets" :key="ticket.ticket">
      <div class="col">
        <a :href="ticket.link" target="_blank" class="text-decoration-none text-body">
          <div :class="{'card h-100 shadow': true, 'stale': daysOld(ticket.updated) >= 5}">
            <div :class="daysOld(ticket.updated) >= 5 ? 'bg-danger text-white card-header' : 'card-header'">
              <span class="ticket-key d-block text-truncate" x-text="ticket.ticket"></span>
            </div>
            <div class="card-body">
              <p class="card-text" x-text="ticket.title"></p>
              <p class="card-text"><small class="text-muted" x-text="'Updated: ' + timeAgo(ticket.updated)"></small></p>
              <template x-if="ticket.dueDate">
                <p class="card-text"><small class="text-muted" x-text="'Due: ' + ticket.dueDate"></small></p>
              </template>
              <p class="card-text">
                <img :src="ticket.avatarUrl" :alt="ticket.assignee" class="rounded-circle me-2" width="32" height="32">
                <small class="text-muted" x-text="'Assignee: ' + ticket.assignee"></small>
              </p>
            </div>
          </div>
        </a>
      </div>

    </template>
  </div>

  <!-- Configured Repositories -->
  <h1 class="mt-5">Repositories</h1>
  <ul x-data="reposApp()" x-init="init()" class="list-group mb-5">
    <template x-for="repo in repos" :key="repo.full">
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span x-text="repo.full"></span>
        <template x-if="repo.link">
          <a :href="repo.link" target="_blank" class="btn btn-sm btn-primary">Open</a>
        </template>
      </li>
    </template>
  </ul>

  <!-- Latest Deployments -->
  <h1 class="mt-5">Latest Deployments</h1>
  <div x-data="deploymentsApp()" x-init="init()" class="table-responsive mb-5">
    <table class="table table-striped table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th scope="col">Repository</th>
          <th scope="col">Environment</th>
          <th scope="col">Name</th>
          <th scope="col">Result</th>
          <th scope="col">Commit</th>
          <th scope="col">Tag</th>
          <th scope="col">Updated</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody>
        <template x-for="d in deployments" :key="d.repository + d.environment">
          <tr>
            <td x-text="d.repository"></td>
            <td x-text="d.environment"></td>
            <td x-text="d.name || d.environment"></td>
            <td>
              <span :class="badgeClass(d.result)" x-text="d.result"></span>
            </td>
            <td><code x-text="d.commit ? d.commit.substring(0,7) : '-' "></code></td>
            <td x-text="d.tag || '-' "></td>
            <td x-text="timeAgo(d.update_time)"></td>
            <td>
              <a :href="d.link" target="_blank" class="btn btn-sm btn-outline-primary" x-show="d.link">Open</a>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>

</div>
<script>
  function ticketsApp() {
    return {
      tickets: [],
      timeAgo(dateString) {
        if (!dateString) return '';
        const now = new Date();
        const updated = new Date(dateString);
        const diffMs = now - updated;
        const diffSec = Math.round(diffMs / 1000);
        if (diffSec < 60) return `${diffSec} seconds ago`;
        const diffMin = Math.round(diffSec / 60);
        if (diffMin < 60) return `${diffMin} minutes ago`;
        const diffHrs = Math.round(diffMin / 60);
        if (diffHrs < 24) return `${diffHrs} hours ago`;
        const diffDays = Math.round(diffHrs / 24);
        return `${diffDays} days ago`;
      },
      isOverdue(dateString) {
        if (!dateString) return false;
        const today = new Date();
        const due = new Date(dateString + 'T00:00:00');
        return due < today;
      },
      daysOld(dateString) {
        return Math.floor((Date.now() - new Date(dateString)) / (1000 * 60 * 60 * 24));
      },
      async load() {
        try {
          const res = await fetch('/in-progress');
          this.tickets = res.ok ? await res.json() : [];
        } catch (err) {
          console.error('Failed to load tickets:', err);
        }
      },
      init() {
        this.load();
        setInterval(() => this.load(), 10000);
      }
    };
  }

  function dueApp() {
    return {
      tickets: [],
      timeAgo(dateString) {
        const now = new Date();
        const updated = new Date(dateString);
        const diffMs = now - updated;
        const diffSec = Math.round(diffMs / 1000);
        if (diffSec < 60) return `${diffSec} seconds ago`;
        const diffMin = Math.round(diffSec / 60);
        if (diffMin < 60) return `${diffMin} minutes ago`;
        const diffHrs = Math.round(diffMin / 60);
        if (diffHrs < 24) return `${diffHrs} hours ago`;
        const diffDays = Math.round(diffHrs / 24);
        return `${diffDays} days ago`;
      },
      isOverdue(dateString) {
        if (!dateString) return false;
        const today = new Date();
        const due = new Date(dateString + 'T00:00:00');
        return due < today;
      },
      async load() {
        try {
          const res = await fetch('/open-issues-by-due');
          this.tickets = res.ok ? await res.json() : [];
        } catch (err) {
          console.error('Failed to load due-date tickets:', err);
        }
      },
      init() {
        this.load();
        setInterval(() => this.load(), 10000); // update every 10 s
      }
    };
  }

  function reposApp() {
    return {
      repos: [],
      async load() {
        try {
          const res = await fetch('/repos');
          this.repos = res.ok ? await res.json() : [];
        } catch (err) {
          console.error('Failed to load repos:', err);
        }
      },
      init() {
        this.load();
      }
    };
  }

  function deploymentsApp() {
    return {
      deployments: [],
      timeAgo(dateString) {
        const now = new Date();
        const updated = new Date(dateString);
        const diffMs = now - updated;
        const diffSec = Math.round(diffMs / 1000);
        if (diffSec < 60) return `${diffSec} seconds ago`;
        const diffMin = Math.round(diffSec / 60);
        if (diffMin < 60) return `${diffMin} minutes ago`;
        const diffHrs = Math.round(diffMin / 60);
        if (diffHrs < 24) return `${diffHrs} hours ago`;
        const diffDays = Math.round(diffHrs / 24);
        return `${diffDays} days ago`;
      },
      badgeClass(result) {
        const res = (result || '').toUpperCase();
        switch (res) {
          case 'SUCCESSFUL':
          case 'COMPLETED':
            return 'badge bg-success';
          case 'FAILED':
          case 'ERROR':
          case 'FAILED_WITH_ERRORS':
            return 'badge bg-danger';
          case 'STOPPED':
          case 'CANCELLED':
            return 'badge bg-secondary';
          case 'IN_PROGRESS':
            return 'badge bg-warning text-dark';
          default:
            return 'badge bg-info';
        }
      },
      async load() {
        try {
          const res = await fetch('/deployments');
          if (res.ok) {
            this.deployments = await res.json();
          } else {
            const txt = await res.text();
            console.error('Failed to load deployments:', res.status, txt);
            this.deployments = [];
          }
        } catch (err) {
          console.error('Failed to load deployments:', err);
        }
      },
      init() {
        this.load();
        setInterval(() => this.load(), 30000); // refresh every 30 seconds
      }
    };
  }
</script>
</body>
</html>
