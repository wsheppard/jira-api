<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jira In Progress Tickets</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    @keyframes wiggle {
      0%, 8%, 100% { transform: rotate(0deg); }
      4%          { transform: rotate(3deg); }
      6%          { transform: rotate(-3deg); }
    }
    .card.stale {
      animation: wiggle 5.5s ease-in-out infinite;
    }
    .card.stale .card-header {
      background-color: #dc3545;
      color: #fff;
    }

    /* Ticket key styling */
    .ticket-key {
      font-size: 1.25rem;
      font-weight: 500;
      width: 100%;
    }
  </style>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body>
<div class="container my-4">
  <!-- Open tickets by due date first -->
  <h1>Open Tickets by Due Date</h1>
  <div x-data="dueApp()" x-init="init()" class="row row-cols-1 row-cols-md-3 g-4 mb-5">
    <template x-for="ticket in tickets" :key="ticket.ticket">
      <div class="col">
        <a :href="ticket.link" target="_blank" class="text-decoration-none text-body">
          <div :class="{'card h-100 shadow': true, 'stale': isOverdue(ticket.dueDate)}">
            <div :class="isOverdue(ticket.dueDate) ? 'bg-danger text-white card-header' : 'card-header bg-info text-white'">
              <span class="ticket-key d-block text-truncate" x-text="ticket.ticket"></span>
            </div>
            <div class="card-body">
              <p class="card-text" x-text="ticket.title"></p>
              <template x-if="ticket.dueDate">
                <p class="card-text"><small class="text-muted" x-text="'Due: ' + ticket.dueDate"></small></p>
              </template>
              <p class="card-text"><small class="text-muted" x-text="'Updated: ' + timeAgo(ticket.updated)"></small></p>
              <p class="card-text">
                <img :src="ticket.avatarUrl" :alt="ticket.assignee" class="rounded-circle me-2" width="32" height="32">
                <small class="text-muted" x-text="'Assignee: ' + ticket.assignee"></small>
              </p>
            </div>
          </div>
        </a>
      </div>
    </template>
  </div>

  <!-- In-progress tickets below -->
  <h1>In Progress Tickets</h1>
  <div x-data="ticketsApp()" x-init="init()" class="row row-cols-1 row-cols-md-3 g-4">
    <template x-for="ticket in tickets" :key="ticket.ticket">
      <div class="col">
        <a :href="ticket.link" target="_blank" class="text-decoration-none text-body">
          <div :class="{'card h-100 shadow': true, 'stale': daysOld(ticket.updated) >= 5}">
            <div :class="daysOld(ticket.updated) >= 5 ? 'bg-danger text-white card-header' : 'card-header'">
              <span class="ticket-key d-block text-truncate" x-text="ticket.ticket"></span>
            </div>
            <div class="card-body">
              <p class="card-text" x-text="ticket.title"></p>
              <p class="card-text"><small class="text-muted" x-text="'Updated: ' + timeAgo(ticket.updated)"></small></p>
              <template x-if="ticket.dueDate">
                <p class="card-text"><small class="text-muted" x-text="'Due: ' + ticket.dueDate"></small></p>
              </template>
              <p class="card-text">
                <img :src="ticket.avatarUrl" :alt="ticket.assignee" class="rounded-circle me-2" width="32" height="32">
                <small class="text-muted" x-text="'Assignee: ' + ticket.assignee"></small>
              </p>
            </div>
          </div>
        </a>
      </div>
    </template>
  </div>
</div>
<script>
  function ticketsApp() {
    return {
      tickets: [],
      timeAgo(dateString) {
        const now = new Date();
        const updated = new Date(dateString);
        const diffMs = now - updated;
        const diffSec = Math.round(diffMs / 1000);
        if (diffSec < 60) return `${diffSec} seconds ago`;
        const diffMin = Math.round(diffSec / 60);
        if (diffMin < 60) return `${diffMin} minutes ago`;
        const diffHrs = Math.round(diffMin / 60);
        if (diffHrs < 24) return `${diffHrs} hours ago`;
        const diffDays = Math.round(diffHrs / 24);
        return `${diffDays} days ago`;
      },
      isOverdue(dateString) {
        if (!dateString) return false;
        const today = new Date();
        const due = new Date(dateString + 'T00:00:00');
        return due < today;
      },
      daysOld(dateString) {
        return Math.floor((Date.now() - new Date(dateString)) / (1000 * 60 * 60 * 24));
      },
      async load() {
        try {
          const res = await fetch('/in-progress');
          this.tickets = res.ok ? await res.json() : [];
        } catch (err) {
          console.error('Failed to load tickets:', err);
        }
      },
      init() {
        this.load();
        setInterval(() => this.load(), 10000);
      }
    };
  }

  function dueApp() {
    return {
      tickets: [],
      timeAgo(dateString) {
        const now = new Date();
        const updated = new Date(dateString);
        const diffMs = now - updated;
        const diffSec = Math.round(diffMs / 1000);
        if (diffSec < 60) return `${diffSec} seconds ago`;
        const diffMin = Math.round(diffSec / 60);
        if (diffMin < 60) return `${diffMin} minutes ago`;
        const diffHrs = Math.round(diffMin / 60);
        if (diffHrs < 24) return `${diffHrs} hours ago`;
        const diffDays = Math.round(diffHrs / 24);
        return `${diffDays} days ago`;
      },
      isOverdue(dateString) {
        if (!dateString) return false;
        const today = new Date();
        const due = new Date(dateString + 'T00:00:00');
        return due < today;
      },
      async load() {
        try {
          const res = await fetch('/open-issues-by-due');
          this.tickets = res.ok ? await res.json() : [];
        } catch (err) {
          console.error('Failed to load due-date tickets:', err);
        }
      },
      init() {
        this.load();
        setInterval(() => this.load(), 10000); // update every 10 s
      }
    };
  }
</script>
</body>
</html>
