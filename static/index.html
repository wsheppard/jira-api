<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jira In Progress Tickets</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    @keyframes wiggle {
      0%, 8%, 100% { transform: rotate(0deg); }
      4%          { transform: rotate(3deg); }
      6%          { transform: rotate(-3deg); }
    }
    .card.stale {
      animation: wiggle 5.5s ease-in-out infinite;
    }
    .card.stale .card-header {
      background-color: #dc3545;
      color: #fff;
    }

    /* Ticket key styling */
    .ticket-key {
      font-size: 1.25rem;
      font-weight: 500;
      width: 100%;
    }

    /* Pipeline ref_name links styling */
    .ref-link {
      display: inline-block;
      margin: 2px 4px 2px 0;
      padding: 2px 8px;
      background-color: #eef;
      border-radius: 3px;
      color: #0366d6;
      text-decoration: none;
      font-size: 0.875rem;
    }
    .ref-link:hover {
      background-color: #dde;
    }
  </style>
  <script type="module" src="/static/index.js"></script>
</head>
<body>
<div class="container my-4">
  <!-- Open tickets by due date first -->
  <h1>Open Tickets by Due Date</h1>
  <div x-data="dueApp()" class="row row-cols-1 row-cols-md-3 g-4 mb-5">
    <template x-for="ticket in tickets" :key="ticket.ticket">
      <div class="col">
        <a :href="ticket.link" target="_blank" class="text-decoration-none text-body">
          <div :class="{'card h-100 shadow': true, 'stale': isOverdue(ticket.dueDate)}">
            <div :class="isOverdue(ticket.dueDate) ? 'bg-danger text-white card-header' : 'card-header bg-info text-white'">
              <span class="ticket-key d-block text-truncate" x-text="ticket.ticket"></span>
            </div>
            <div class="card-body">
              <p class="card-text" x-text="ticket.title"></p>
              <template x-if="ticket.dueDate">
                <p class="card-text"><small class="text-muted" x-text="'Due: ' + ticket.dueDate"></small></p>
              </template>
              <p class="card-text"><small class="text-muted" x-text="'Updated: ' + timeAgo(ticket.updated)"></small></p>
              <p class="card-text">
                <img :src="ticket.avatarUrl" :alt="ticket.assignee" class="rounded-circle me-2" width="32" height="32">
                <small class="text-muted" x-text="'Assignee: ' + ticket.assignee"></small>
              </p>
            </div>
          </div>
        </a>
      </div>
    </template>
  </div>

  <!-- In-progress tickets below -->
  <h1>In Progress Tickets</h1>
  <div x-data="ticketsApp()" class="row row-cols-1 row-cols-md-3 g-4">
    <template x-for="ticket in tickets" :key="ticket.ticket">
      <div class="col">
        <a :href="ticket.link" target="_blank" class="text-decoration-none text-body">
          <div :class="{'card h-100 shadow': true, 'stale': daysOld(ticket.updated) >= 5}">
            <div :class="daysOld(ticket.updated) >= 5 ? 'bg-danger text-white card-header' : 'card-header'">
              <span class="ticket-key d-block text-truncate" x-text="ticket.ticket"></span>
            </div>
            <div class="card-body">
              <p class="card-text" x-text="ticket.title"></p>
              <p class="card-text"><small class="text-muted" x-text="'Updated: ' + timeAgo(ticket.updated)"></small></p>
              <template x-if="ticket.dueDate">
                <p class="card-text"><small class="text-muted" x-text="'Due: ' + ticket.dueDate"></small></p>
              </template>
              <p class="card-text">
                <img :src="ticket.avatarUrl" :alt="ticket.assignee" class="rounded-circle me-2" width="32" height="32">
                <small class="text-muted" x-text="'Assignee: ' + ticket.assignee"></small>
              </p>
            </div>
          </div>
        </a>
      </div>

    </template>
  </div>

  <!-- Latest Tag per Environment -->
  <div x-data="pipelineDashboardApp()" class="mb-5">
    <h1 class="mt-5">Latest Tag per Environment</h1>
    <div class="table-responsive mb-4">
      <table class="table table-striped table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">Environment</th>
            <th scope="col">Frontend</th>
            <th scope="col">Backend</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="env in categories" :key="env">
            <tr>
              <td x-text="envDisplay(env)"></td>
              <td>
                <span x-text="(data.frontend[env] ?? [])[0]?.ref_name || '-'"
                      ></span>
                <template x-if="(data.frontend[env] ?? [])[0]?.completed_on">
                  <small class="text-muted"
                         x-text="' (' + timeAgo((data.frontend[env] ?? [])[0].completed_on) + ')'"
                  ></small>
                </template>
              </td>
              <td>
                <span x-text="(data.backend[env] ?? [])[0]?.ref_name || '-'"
                      ></span>
                <template x-if="(data.backend[env] ?? [])[0]?.completed_on">
                  <small class="text-muted"
                         x-text="' (' + timeAgo((data.backend[env] ?? [])[0].completed_on) + ')'"
                  ></small>
                </template>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

  <!-- Pipeline Dashboard -->
    <h1 class="mt-5">Pipeline Dashboard</h1>
    <template x-for="(repoData, repo) in data" :key="repo">
      <div class="mb-5">
        <h2 class="mt-4" x-text="repo"></h2>
        <template x-for="env in categories" :key="env">
          <div class="mb-4">
            <h3 x-text="envDisplay(env)"></h3>
            <div class="table-responsive">
              <table class="table table-striped table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th scope="col">Result</th>
                    <th scope="col">Ref Name</th>
                    <th scope="col">Commit</th>
                    <th scope="col">Completed</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(run, index) in (repoData[env] ?? [])" :key="run.uuid || index">
                    <tr>
                      <td><span :class="badgeClass(run.result)" x-text="run.result"></span></td>
                      <td>
                        <a
                          :href="run.pipeline_link"
                          class="ref-link"
                          target="_blank"
                          x-text="run.ref_name"
                        ></a>
                      </td>
                      <td><a :href="run.commit_link" target="_blank" x-text="run.commit"></a></td>
                      <td x-text="timeAgo(run.completed_on)"></td>
                    </tr>
                  </template>
                  <template x-if="!(repoData[env] ?? []).length">
                    <tr>
                      <td colspan="4">-</td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </template>
      </div>
    </template>
  </div>

</div>
</body>
</html>
